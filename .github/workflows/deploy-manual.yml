name: Manual Deployment to cPanel

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      run_migrations:
        description: 'Run database migrations'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Manual Deploy to cPanel
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          tools: composer:v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Composer Dependencies (Production)
        run: composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

      - name: Install Node Dependencies
        run: npm ci

      - name: Build Frontend Assets
        run: npm run build
        env:
          NODE_ENV: production

      - name: Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          server-dir: ${{ secrets.CPANEL_DEPLOY_PATH }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/.env.example
            **/phpunit.xml
            **/.github/**
          log-level: verbose

      - name: Execute Post-Deployment Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_SSH_HOST }}
          username: ${{ secrets.CPANEL_SSH_USERNAME }}
          password: ${{ secrets.CPANEL_SSH_PASSWORD }}
          port: ${{ secrets.CPANEL_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.CPANEL_DEPLOY_PATH }}
            
            # Optimize Laravel
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Run migrations if requested
            if [ "${{ inputs.run_migrations }}" == "true" ]; then
              echo "Running database migrations..."
              php artisan migrate --force
            fi
            
            # Create storage link if it doesn't exist
            php artisan storage:link
            
            # Set proper permissions
            chmod -R 755 storage bootstrap/cache
            
            echo "✅ Manual deployment to ${{ inputs.environment }} completed!"

      - name: Deployment Summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Migrations**: ${{ inputs.run_migrations }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY
