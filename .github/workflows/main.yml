name: Deploy to cPanel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          tools: composer:v2
          coverage: none

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Composer Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install Node Dependencies
        run: npm ci

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Run Tests
        run: ./vendor/bin/phpunit

  deploy:
    name: Deploy to cPanel
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          tools: composer:v2
          coverage: none

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Composer Dependencies (Production)
        run: composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

      - name: Install Node Dependencies
        run: npm ci

      - name: Build Frontend Assets
        run: npm run build
        env:
          NODE_ENV: production

      - name: Create Deployment Archive
        run: |
          # Remove development files
          rm -rf node_modules
          rm -rf tests
          rm -rf .git
          rm -f .env.example
          rm -f phpunit.xml
          rm -f package-lock.json
          
          # Create deployment package
          tar -czf deploy.tar.gz \
            --exclude='.github' \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env.example' \
            --exclude='phpunit.xml' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            .

      - name: Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          server-dir: ${{ secrets.CPANEL_DEPLOY_PATH }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/.env.example
            **/phpunit.xml
            **/package-lock.json
            **/.editorconfig
            **/.prettierrc
            **/eslint.config.js
            **/.github/**
            **/storage/logs/**
            **/storage/framework/cache/data/**
            **/storage/framework/sessions/**
            **/storage/framework/views/**
            **/database/database.sqlite
          log-level: verbose

      - name: Execute Post-Deployment Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_SSH_HOST }}
          username: ${{ secrets.CPANEL_SSH_USERNAME }}
          password: ${{ secrets.CPANEL_SSH_PASSWORD }}
          port: ${{ secrets.CPANEL_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.CPANEL_DEPLOY_PATH }}
            
            # Check if composer exists
            if command -v composer &> /dev/null; then
              # Optimize Laravel
              php artisan config:cache
              php artisan route:cache
              php artisan view:cache
              
              # Run migrations (optional - comment out if you want to run manually)
              # php artisan migrate --force
              
              # Create storage link if it doesn't exist
              php artisan storage:link
              
              # Set proper permissions
              chmod -R 755 storage bootstrap/cache
              
              echo "Deployment completed successfully!"
            else
              echo "Composer not found. Please install Composer on your cPanel server."
              echo "Deployment files uploaded but optimization skipped."
            fi

      - name: Deployment Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to cPanel completed successfully!"
          else
            echo "❌ Deployment failed. Please check the logs."
          fi
